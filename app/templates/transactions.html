{% extends 'base.html' %}

{% block content %}
<h2>Транзакции</h2>

<div class="add-transaction">
    <form id="transactionForm">
        <input type="number" step="0.01" name="amount" placeholder="Сумма" required>
        <select name="type" required>
            <option value="income">Доход</option>
            <option value="expense">Расход</option>
        </select>
        <select name="category_id" id="categorySelect">
            <option value="">Выберите категорию</option>
        </select>
        <input type="text" name="description" placeholder="Описание">
        <button type="submit">Добавить</button>
    </form>
</div>

<div class="transactions">
    <table>
        <thead>
            <tr>
                <th>Дата</th>
                <th>Тип</th>
                <th>Категория</th>
                <th>Описание</th>
                <th>Сумма</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody id="transactionTable"></tbody>
    </table>
</div>

<script>
const token = localStorage.getItem('token');

async function loadTransactions() {
    const response = await fetch('/dashboard/data', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!response.ok) return alert('Ошибка загрузки транзакций');
    const data = await response.json();

    // Обновляем таблицу
    const tableBody = document.getElementById('transactionTable');
    tableBody.innerHTML = '';
    data.transactions.forEach(t => {
        const tr = document.createElement('tr');
        tr.dataset.id = t.id;
        tr.innerHTML = `
            <td>${t.date}</td>
            <td>${t.type === 'income' ? 'Доход' : 'Расход'}</td>
            <td>${t.category || '-'}</td>
            <td>${t.description || ''}</td>
            <td>${t.amount.toFixed(2)}</td>
            <td><button class="deleteBtn">Удалить</button></td>
        `;
        tableBody.appendChild(tr);
    });

    // Обновляем категории в форме
    const categorySelect = document.getElementById('categorySelect');
    categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
    data.categories.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.innerText = c.name;
        categorySelect.appendChild(opt);
    });

    // Обработчик удаления
    document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', async e => {
            const id = e.target.closest('tr').dataset.id;
            const resp = await fetch(`/dashboard/delete_transaction/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(resp.ok) loadTransactions();
        });
    });
}

document.getElementById('transactionForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.amount = parseFloat(data.amount);
    const response = await fetch('/dashboard/add_transaction', {
        method: 'POST',
        headers: {'Content-Type':'application/json','Authorization': `Bearer ${token}`},
        body: JSON.stringify(data)
    });
    if(response.ok) {
        e.target.reset();
        loadTransactions();
    } else {
        alert('Ошибка при добавлении транзакции');
    }
});

loadTransactions();
</script>
{% endblock %}

